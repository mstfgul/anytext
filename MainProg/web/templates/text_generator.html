{% extends "base.html" %}

{% block title %}Text Generator{% endblock %}

{% block additional_css %}
<style>
    .sidebar {
        position: sticky;
        top: 20px;
    }
    
    .text-content {
        font-size: var(--text-font-size, 16px);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        color: white;
        flex-direction: column;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Loading Overlay -->
    <div class="loading-overlay d-none" id="loadingOverlay">
        <div class="spinner-border mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 id="loadingMessage">Generating text...</h4>
    </div>

    <!-- Left Sidebar - Controls -->
    <div class="col-lg-4 mb-4">
        <div class="sidebar card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-sliders-h me-2"></i>Generator Settings
                </h5>
            </div>
            <div class="card-body">
                <form id="textGeneratorForm">
                    <!-- Language & Level -->
                    <div class="mb-3">
                        <label for="language" class="form-label">Language</label>
                        <select class="form-select" id="language" name="language">
                            {% for language in languages %}
                            <option value="{{ language }}">{{ language }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="level" class="form-label">Proficiency Level</label>
                        <select class="form-select" id="level" name="level">
                            {% for level in levels %}
                            <option value="{{ level }}">{{ level }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Text Options -->
                    <div class="mb-3">
                        <label for="wordCount" class="form-label">Text Length</label>
                        <select class="form-select" id="wordCount" name="wordCount">
                            {% for count in word_counts %}
                            <option value="{{ count }}">{{ count }} words</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="textType" class="form-label">Text Type</label>
                        <select class="form-select" id="textType" name="textType">
                            {% for type in text_types %}
                            <option value="{{ type }}">{{ type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Topic Selection -->
                    <div class="mb-3">
                        <label class="form-label">Topic Selection</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="topicOption" id="randomTopic" value="random" checked>
                            <label class="form-check-label" for="randomTopic">
                                Generate Random Topic
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="topicOption" id="customTopic" value="custom">
                            <label class="form-check-label" for="customTopic">
                                Set Custom Topic
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3 d-none" id="customTopicInput">
                        <label for="topic" class="form-label">Enter Topic</label>
                        <input type="text" class="form-control" id="topic" name="topic" placeholder="e.g., Climate Change">
                    </div>
                    
                    <!-- Popular Topics -->
                    <div class="mb-3" id="popularTopicsSection">
                        <label class="form-label">Popular Topics</label>
                        <div class="d-flex flex-wrap gap-2 popular-topics" id="popularTopics">
                            <!-- Popular topics will be added here dynamically -->
                        </div>
                    </div>
                    
                    <!-- Additional Options -->
                    <div class="mb-3">
                        <label class="form-label">Additional Content</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeSummary" name="includeSummary" checked>
                            <label class="form-check-label" for="includeSummary">
                                Include Summary
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeKeyWords" name="includeKeyWords" checked>
                            <label class="form-check-label" for="includeKeyWords">
                                Include Key Vocabulary
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeQuestions" name="includeQuestions" checked>
                            <label class="form-check-label" for="includeQuestions">
                                Include Comprehension Questions
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeExercises" name="includeExercises" checked>
                            <label class="form-check-label" for="includeExercises">
                                Include Language Exercises
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeTranslation" name="includeTranslation">
                            <label class="form-check-label" for="includeTranslation">
                                Include Line-by-Line Translation
                            </label>
                        </div>
                    </div>
                    
                    <!-- Translation Options -->
                    <div class="mb-3 d-none" id="translationOptions">
                        <label for="translationLanguage" class="form-label">Target Language</label>
                        <select class="form-select" id="translationLanguage" name="translationLanguage">
                            {% for language in languages %}
                            <option value="{{ language }}">{{ language }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Generate Button -->
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-magic me-2"></i>Generate Text
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Right Content - Text Display -->
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0" id="textTitle">
                    <i class="fas fa-file-alt me-2"></i>Generated Text
                </h5>
            </div>
            <div class="card-body">
                <div id="initialMessage" class="text-center py-5">
                    <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No text generated yet</h4>
                    <p>Adjust the settings and click "Generate Text" to create a new text.</p>
                </div>
                
                <div id="textContent" class="d-none">
                    <!-- Tabs for different content -->
                    <ul class="nav nav-tabs" id="contentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text" type="button" role="tab" aria-controls="text" aria-selected="true">
                                <i class="fas fa-file-alt me-1"></i> Text
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="false">
                                <i class="fas fa-list me-1"></i> Summary
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="vocabulary-tab" data-bs-toggle="tab" data-bs-target="#vocabulary" type="button" role="tab" aria-controls="vocabulary" aria-selected="false">
                                <i class="fas fa-book me-1"></i> Vocabulary
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab" aria-controls="questions" aria-selected="false">
                                <i class="fas fa-question-circle me-1"></i> Questions
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="exercises-tab" data-bs-toggle="tab" data-bs-target="#exercises" type="button" role="tab" aria-controls="exercises" aria-selected="false">
                                <i class="fas fa-tasks me-1"></i> Exercises
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="translation-tab" data-bs-toggle="tab" data-bs-target="#translation" type="button" role="tab" aria-controls="translation" aria-selected="false">
                                <i class="fas fa-language me-1"></i> Translation
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content p-3" id="contentTabsContent">
                        <!-- Text Tab -->
                        <div class="tab-pane fade show active" id="text" role="tabpanel" aria-labelledby="text-tab">
                            <div class="text-content" id="mainText"></div>
                        </div>
                        
                        <!-- Summary Tab -->
                        <div class="tab-pane fade" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                            <div id="summaryContent">
                                <div class="text-center py-4 summary-placeholder">
                                    <i class="fas fa-list fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">No summary generated yet.</p>
                                    <button class="btn btn-sm btn-primary" id="generateSummaryBtn">
                                        <i class="fas fa-magic me-1"></i>Generate Summary
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Vocabulary Tab -->
                        <div class="tab-pane fade" id="vocabulary" role="tabpanel" aria-labelledby="vocabulary-tab">
                            <div id="vocabularyContent">
                                <div class="text-center py-4 vocabulary-placeholder">
                                    <i class="fas fa-book fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">No vocabulary list generated yet.</p>
                                    <button class="btn btn-sm btn-primary" id="generateVocabularyBtn">
                                        <i class="fas fa-magic me-1"></i>Generate Vocabulary
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Questions Tab -->
                        <div class="tab-pane fade" id="questions" role="tabpanel" aria-labelledby="questions-tab">
                            <div id="questionsContent">
                                <div class="text-center py-4 questions-placeholder">
                                    <i class="fas fa-question-circle fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">No comprehension questions generated yet.</p>
                                    <button class="btn btn-sm btn-primary" id="generateQuestionsBtn">
                                        <i class="fas fa-magic me-1"></i>Generate Questions
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Exercises Tab -->
                        <div class="tab-pane fade" id="exercises" role="tabpanel" aria-labelledby="exercises-tab">
                            <div id="exercisesContent">
                                <div class="text-center py-4 exercises-placeholder">
                                    <i class="fas fa-tasks fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">No language exercises generated yet.</p>
                                    <button class="btn btn-sm btn-primary" id="generateExercisesBtn">
                                        <i class="fas fa-magic me-1"></i>Generate Exercises
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Translation Tab -->
                        <div class="tab-pane fade" id="translation" role="tabpanel" aria-labelledby="translation-tab">
                            <div id="translationContent">
                                <div class="text-center py-4 translation-placeholder">
                                    <i class="fas fa-language fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">No translation generated yet.</p>
                                    <div class="mb-3">
                                        <label for="translationTargetLang" class="form-label">Target Language</label>
                                        <select class="form-select" id="translationTargetLang">
                                            {% for language in languages %}
                                            <option value="{{ language }}">{{ language }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <button class="btn btn-sm btn-primary" id="generateTranslationBtn">
                                        <i class="fas fa-magic me-1"></i>Generate Translation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Actions Buttons -->
        <div class="d-flex justify-content-between mb-4" id="actionButtons">
            <div class="btn-group">
                <button class="btn btn-outline-primary" id="copyTextBtn" disabled>
                    <i class="fas fa-copy me-1"></i>Copy Text
                </button>
                <button class="btn btn-outline-primary" id="printTextBtn" disabled>
                    <i class="fas fa-print me-1"></i>Print
                </button>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-outline-success" id="saveTextBtn" disabled>
                    <i class="fas fa-save me-1"></i>Save
                </button>
                <button class="btn btn-outline-danger" id="clearTextBtn" disabled>
                    <i class="fas fa-trash me-1"></i>Clear
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script>
    // Current text data
    let currentTextData = null;
    
    $(document).ready(function() {
        // Load settings
        const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
        if (settings.defaultLanguage) {
            $('#language').val(settings.defaultLanguage);
        }
        if (settings.defaultLevel) {
            $('#level').val(settings.defaultLevel);
        }
        if (settings.fontSize) {
            document.documentElement.style.setProperty('--text-font-size', `${settings.fontSize}px`);
        }
        
        // Toggle custom topic input
        $('input[name="topicOption"]').change(function() {
            if ($('#customTopic').is(':checked')) {
                $('#customTopicInput').removeClass('d-none');
                $('#popularTopicsSection').addClass('d-none');
            } else {
                $('#customTopicInput').addClass('d-none');
                $('#popularTopicsSection').removeClass('d-none');
            }
        });
        
        // Toggle translation options
        $('#includeTranslation').change(function() {
            if ($(this).is(':checked')) {
                $('#translationOptions').removeClass('d-none');
                // Set default translation language different from main language
                const mainLang = $('#language').val();
                $('#translationLanguage option').each(function() {
                    if ($(this).val() !== mainLang) {
                        $('#translationLanguage').val($(this).val());
                        return false; // break the loop
                    }
                });
            } else {
                $('#translationOptions').addClass('d-none');
            }
        });
        
        // Update translation language options when main language changes
        $('#language').change(function() {
            const mainLang = $(this).val();
            $('#translationLanguage option').prop('disabled', false);
            $(`#translationLanguage option[value="${mainLang}"]`).prop('disabled', true);
            
            // If current selection is now disabled, change it
            if ($('#translationLanguage').val() === mainLang) {
                $('#translationLanguage option').each(function() {
                    if ($(this).val() !== mainLang) {
                        $('#translationLanguage').val($(this).val());
                        return false; // break the loop
                    }
                });
            }
            
            // Also update translation tab's language selector
            $('#translationTargetLang option').prop('disabled', false);
            $(`#translationTargetLang option[value="${mainLang}"]`).prop('disabled', true);
            
            // Update popular topics based on level
            updatePopularTopics();
        });
        
        // Update popular topics when level changes
        $('#level').change(function() {
            updatePopularTopics();
        });
        
        // Popular topics handler
        $(document).on('click', '.topic-badge', function() {
            const topic = $(this).text();
            $('#customTopic').prop('checked', true).trigger('change');
            $('#topic').val(topic);
        });
        
        // Initialize popular topics
        updatePopularTopics();
        
        // Form submission - Generate text
        $('#textGeneratorForm').submit(function(e) {
            e.preventDefault();
            generateText();
        });
        
        // Generate additional content buttons
        $('#generateSummaryBtn').click(function() {
            generateSummary();
        });
        
        $('#generateVocabularyBtn').click(function() {
            generateVocabulary();
        });
        
        $('#generateQuestionsBtn').click(function() {
            generateQuestions();
        });
        
        $('#generateExercisesBtn').click(function() {
            generateExercises();
        });
        
        $('#generateTranslationBtn').click(function() {
            generateTranslation();
        });
        
        // Action buttons
        $('#copyTextBtn').click(function() {
            copyTextToClipboard();
        });
        
        $('#printTextBtn').click(function() {
            printText();
        });
        
        $('#saveTextBtn').click(function() {
            saveText();
        });
        
        $('#clearTextBtn').click(function() {
            clearText();
        });
    });
    
    // Update popular topics based on language and level
    function updatePopularTopics() {
        const level = $('#level').val();
        
        // Define popular topics by level
        const popularTopics = {
            'A1-A2': ["Daily Routines", "Family and Friends", "Weather", "Hobbies", "Food"],
            'B1-B2': ["Travel Experiences", "Sports and Health", "Environmental Issues", "Technology", "Cultural Differences"],
            'C1-C2': ["Global Economy", "Philosophy and Ethics", "Literature and Art", "Scientific Developments", "Social Change"]
        };
        
        // Get topics for selected level
        const topics = popularTopics[level] || popularTopics['B1-B2'];
        
        // Clear current topics
        $('#popularTopics').empty();
        
        // Add topics as badges
        topics.forEach(topic => {
            $('#popularTopics').append(`
                <span class="badge bg-light text-primary border cursor-pointer topic-badge">${topic}</span>
            `);
        });
    }
    
    // Generate text
    function generateText() {
        // Show loading overlay
        $('#loadingOverlay').removeClass('d-none');
        $('#loadingMessage').text('Generating text...');
        
        // Get form data
        const language = $('#language').val();
        const level = $('#level').val();
        const wordCount = $('#wordCount').val();
        const textType = $('#textType').val();
        const topicOption = $('input[name="topicOption"]:checked').val();
        const topic = topicOption === 'custom' ? $('#topic').val() : '';
        
        // Additional options
        const includeSummary = $('#includeSummary').is(':checked');
        const includeKeyWords = $('#includeKeyWords').is(':checked');
        const includeQuestions = $('#includeQuestions').is(':checked');
        const includeExercises = $('#includeExercises').is(':checked');
        const includeTranslation = $('#includeTranslation').is(':checked');
        const translationLanguage = $('#translationLanguage').val();
        
        // Get settings from localStorage
        const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
        const temperature = settings.temperature || 0.7;
        const topP = settings.topP || 0.9;
        const saveHistory = settings.saveHistory !== undefined ? settings.saveHistory : true;
        
        // Prepare request data
        const requestData = {
            language,
            level,
            word_count: parseInt(wordCount),
            text_type: textType,
            topic,
            temperature,
            top_p: topP,
            include_summary: includeSummary,
            include_key_words: includeKeyWords,
            include_questions: includeQuestions,
            include_exercises: includeExercises,
            include_translation: includeTranslation,
            translation_language: includeTranslation ? translationLanguage : null,
            save_history: saveHistory
        };
        
        // Make API request
        $.ajax({
            url: '/api/generate-text',
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    currentTextData = response.text;
                    displayText(currentTextData);
                } else {
                    showAlert('Error generating text: ' + (response.error || 'Unknown error'), 'danger');
                }
                $('#loadingOverlay').addClass('d-none');
            },
            error: function(xhr, status, error) {
                showAlert('Failed to generate text. Please try again.', 'danger');
                $('#loadingOverlay').addClass('d-none');
                console.error(error);
            }
        });
    }
    
    // Display generated text and additional content
    function displayText(textData) {
        // Update title
        $('#textTitle').html(`<i class="fas fa-file-alt me-2"></i>${textData.topic}`);
        
        // Show text content, hide initial message
        $('#initialMessage').addClass('d-none');
        $('#textContent').removeClass('d-none');
        
        // Enable action buttons
        $('#copyTextBtn, #printTextBtn, #saveTextBtn, #clearTextBtn').prop('disabled', false);
        
        // Display main text
        $('#mainText').html(textData.text.replace(/\n/g, '<br>'));
        
        // Display summary if available
        if (textData.summary) {
            $('#summaryContent').html(`
                <div class="text-content">
                    ${textData.summary.replace(/\n/g, '<br>')}
                </div>
            `);
        } else {
            $('#summaryContent').html(`
                <div class="text-center py-4 summary-placeholder">
                    <i class="fas fa-list fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No summary generated yet.</p>
                    <button class="btn btn-sm btn-primary" id="generateSummaryBtn">
                        <i class="fas fa-magic me-1"></i>Generate Summary
                    </button>
                </div>
            `);
        }
        
        // Display vocabulary if available
        if (textData.key_words && (Array.isArray(textData.key_words) || typeof textData.key_words === 'object')) {
            displayVocabulary(textData.key_words);
        } else {
            $('#vocabularyContent').html(`
                <div class="text-center py-4 vocabulary-placeholder">
                    <i class="fas fa-book fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No vocabulary list generated yet.</p>
                    <button class="btn btn-sm btn-primary" id="generateVocabularyBtn">
                        <i class="fas fa-magic me-1"></i>Generate Vocabulary
                    </button>
                </div>
            `);
        }
        
        // Display questions if available
        if (textData.questions) {
            displayQuestions(textData.questions);
        } else {
            $('#questionsContent').html(`
                <div class="text-center py-4 questions-placeholder">
                    <i class="fas fa-question-circle fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No comprehension questions generated yet.</p>
                    <button class="btn btn-sm btn-primary" id="generateQuestionsBtn">
                        <i class="fas fa-magic me-1"></i>Generate Questions
                    </button>
                </div>
            `);
        }
        
        // Display exercises if available
        if (textData.exercises) {
            displayExercises(textData.exercises);
        } else {
            $('#exercisesContent').html(`
                <div class="text-center py-4 exercises-placeholder">
                    <i class="fas fa-tasks fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No language exercises generated yet.</p>
                    <button class="btn btn-sm btn-primary" id="generateExercisesBtn">
                        <i class="fas fa-magic me-1"></i>Generate Exercises
                    </button>
                </div>
            `);
        }
        
        // Display translation if available
        if (textData.translation) {
            displayTranslation(textData.translation, textData.translation_language);
        } else {
            $('#translationContent').html(`
                <div class="text-center py-4 translation-placeholder">
                    <i class="fas fa-language fa-2x text-muted mb-2"></i>
                    <p class="text-muted">No translation generated yet.</p>
                    <div class="mb-3">
                        <label for="translationTargetLang" class="form-label">Target Language</label>
                        <select class="form-select" id="translationTargetLang">
                            ${generateLanguageOptions(textData.language)}
                        </select>
                    </div>
                    <button class="btn btn-sm btn-primary" id="generateTranslationBtn">
                        <i class="fas fa-magic me-1"></i>Generate Translation
                    </button>
                </div>
            `);
        }
        
        // Rebind event handlers for dynamic content
        $('#generateSummaryBtn').click(function() {
            generateSummary();
        });
        
        $('#generateVocabularyBtn').click(function() {
            generateVocabulary();
        });
        
        $('#generateQuestionsBtn').click(function() {
            generateQuestions();
        });
        
        $('#generateExercisesBtn').click(function() {
            generateExercises();
        });
        
        $('#generateTranslationBtn').click(function() {
            generateTranslation();
        });
    }
    
    // Generate language options excluding current language
    function generateLanguageOptions(currentLanguage) {
        const languages = [
            "English", "Turkish", "German", "French", "Spanish",
            "Italian", "Dutch", "Russian", "Portuguese", "Japanese"
        ];
        
        return languages.map(lang => {
            const disabled = lang === currentLanguage ? 'disabled' : '';
            const selected = lang !== currentLanguage ? 'selected' : '';
            return `<option value="${lang}" ${disabled} ${selected}>${lang}</option>`;
        }).join('');
    }
    
    // Display vocabulary
    function displayVocabulary(vocabularyData) {
        let html = '<div class="accordion" id="vocabularyAccordion">';
        
        try {
            const vocabItems = Array.isArray(vocabularyData) ? 
                vocabularyData : 
                (vocabularyData.hasOwnProperty('length') ? vocabularyData : [vocabularyData]);
            
            vocabItems.forEach((item, index) => {
                const word = item.word || '';
                const definition = item.definition || '';
                const example = item.example || '';
                
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="vocab-heading-${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vocab-collapse-${index}" aria-expanded="false" aria-controls="vocab-collapse-${index}">
                                ${word}
                            </button>
                        </h2>
                        <div id="vocab-collapse-${index}" class="accordion-collapse collapse" aria-labelledby="vocab-heading-${index}" data-bs-parent="#vocabularyAccordion">
                            <div class="accordion-body">
                                <p><strong>Definition:</strong> ${definition}</p>
                                <p><strong>Example:</strong> ${example}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        } catch (e) {
            console.error('Error parsing vocabulary data', e);
            html = `<div class="alert alert-warning">
                        Could not display vocabulary data in the expected format.
                    </div>
                    <pre>${JSON.stringify(vocabularyData, null, 2)}</pre>`;
        }
        
        html += '</div>';
        $('#vocabularyContent').html(html);
    }
    
    // Display questions
    function displayQuestions(questionsData) {
        let html = '<div class="accordion" id="questionsAccordion">';
        
        try {
            let questionItems = [];
            
            if (Array.isArray(questionsData)) {
                questionItems = questionsData;
            } else if (typeof questionsData === 'object') {
                if (questionsData.questions && Array.isArray(questionsData.questions)) {
                    questionItems = questionsData.questions;
                } else {
                    questionItems = [questionsData];
                }
            }
            
            questionItems.forEach((item, index) => {
                const question = item.question || '';
                const answer = item.answer || '';
                
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="question-heading-${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#question-collapse-${index}" aria-expanded="false" aria-controls="question-collapse-${index}">
                                ${question}
                            </button>
                        </h2>
                        <div id="question-collapse-${index}" class="accordion-collapse collapse" aria-labelledby="question-heading-${index}" data-bs-parent="#questionsAccordion">
                            <div class="accordion-body">
                                <p><strong>Answer:</strong> ${answer}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
        } catch (e) {
            console.error('Error parsing questions data', e);
            html = `<div class="alert alert-warning">
                        Could not display questions data in the expected format.
                    </div>
                    <pre>${JSON.stringify(questionsData, null, 2)}</pre>`;
        }
        
        html += '</div>';
        $('#questionsContent').html(html);
    }
    
    // Display exercises
    function displayExercises(exercisesData) {
        let html = '<div class="accordion" id="exercisesAccordion">';
        
        try {
            let exerciseItems = [];
            
            if (Array.isArray(exercisesData)) {
                exerciseItems = exercisesData;
            } else if (typeof exercisesData === 'object') {
                if (exercisesData.exercises && Array.isArray(exercisesData.exercises)) {
                    exerciseItems = exercisesData.exercises;
                } else {
                    exerciseItems = [exercisesData];
                }
            }
            
            exerciseItems.forEach((item, index) => {
                const instructions = item.instructions || '';
                const content = item.content || '';
                const solution = item.solution || '';
                
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="exercise-heading-${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#exercise-collapse-${index}" aria-expanded="false" aria-controls="exercise-collapse-${index}">
                                Exercise ${index+1}: ${instructions}
                            </button>
                        </h2>
                        <div id="exercise-collapse-${index}" class="accordion-collapse collapse" aria-labelledby="exercise-heading-${index}" data-bs-parent="#exercisesAccordion">
                            <div class="accordion-body">
                                <p><strong>Content:</strong> ${content}</p>
                                <p class="mt-3 solution-hidden">
                                    <button class="btn btn-sm btn-outline-primary show-solution-btn" data-index="${index}">
                                        <i class="fas fa-eye me-1"></i>Show Solution
                                    </button>
                                </p>
                                <div class="solution-content solution-${index} d-none">
                                    <p><strong>Solution:</strong> ${solution}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        } catch (e) {
            console.error('Error parsing exercises data', e);
            html = `<div class="alert alert-warning">
                        Could not display exercises data in the expected format.
                    </div>
                    <pre>${JSON.stringify(exercisesData, null, 2)}</pre>`;
        }
        
        html += '</div>';
        $('#exercisesContent').html(html);
        
        // Add event listener for show solution buttons
        $('.show-solution-btn').click(function() {
            const index = $(this).data('index');
            $(this).addClass('d-none');
            $(`.solution-${index}`).removeClass('d-none');
        });
    }
    
    // Display translation
    function displayTranslation(translationData, targetLanguage) {
        let html = `
            <div class="mb-3">
                <h5>Translation to ${targetLanguage || 'other language'}</h5>
            </div>
        `;
        
        try {
            if (Array.isArray(translationData)) {
                html += '<div class="translation-content">';
                
                translationData.forEach((item) => {
                    const original = item.original || '';
                    const translation = item.translation || '';
                    
                    html += `
                        <div class="row mb-3 border-bottom pb-2">
                            <div class="col-md-6">
                                <div class="original-text">
                                    <p>${original}</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="translation-text">
                                    <p>${translation}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html = `<div class="alert alert-warning">
                            Could not display translation data in the expected format.
                        </div>
                        <pre>${JSON.stringify(translationData, null, 2)}</pre>`;
            }
        } catch (e) {
            console.error('Error parsing translation data', e);
            html = `<div class="alert alert-warning">
                        Could not display translation data in the expected format.
                    </div>
                    <pre>${JSON.stringify(translationData, null, 2)}</pre>`;
        }
        
        $('#translationContent').html(html);
    }
    
    // Generate summary for existing text
    function generateSummary() {
        if (!currentTextData) return;
        
        $('#loadingOverlay').removeClass('d-none');
        $('#loadingMessage').text('Generating summary...');
        
        $.ajax({
            url: '/api/generate-summary',
            type: 'POST',
            data: JSON.stringify({
                text: currentTextData.text,
                language: currentTextData.language,
                level: currentTextData.level
            }),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    currentTextData.summary = response.summary;
                    $('#summaryContent').html(`
                        <div class="text-content">
                            ${response.summary.replace(/\n/g, '<br>')}
                        </div>
                    `);
                } else {
                    showAlert('Error generating summary: ' + (response.error || 'Unknown error'), 'danger');
                }
                $('#loadingOverlay').addClass('d-none');
            },
            error: function(xhr, status, error) {
                showAlert('Failed to generate summary. Please try again.', 'danger');
                $('#loadingOverlay').addClass('d-none');
                console.error(error);
            }
        });
    }
    
    // Generate vocabulary for existing text
    function generateVocabulary() {
        // Similar to generateSummary, implement API call for vocabulary
        showAlert('Vocabulary generation functionality will be implemented in the next update.', 'info');
    }
    
    // Generate questions for existing text
    function generateQuestions() {
        // Similar to generateSummary, implement API call for questions
        showAlert('Questions generation functionality will be implemented in the next update.', 'info');
    }
    
    // Generate exercises for existing text
    function generateExercises() {
        // Similar to generateSummary, implement API call for exercises
        showAlert('Exercises generation functionality will be implemented in the next update.', 'info');
    }
    
    // Generate translation for existing text
    function generateTranslation() {
        // Similar to generateSummary, implement API call for translation
        showAlert('Translation functionality will be implemented in the next update.', 'info');
    }
    
    // Copy text to clipboard
    function copyTextToClipboard() {
        if (!currentTextData) return;
        
        const textToCopy = currentTextData.text;
        
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                showAlert('Text copied to clipboard!', 'success');
            })
            .catch(() => {
                showAlert('Failed to copy text. Please try again.', 'danger');
            });
    }
    
    // Print text
    function printText() {
        if (!currentTextData) return;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>${currentTextData.topic}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            line-height: 1.6;
                        }
                        h1 {
                            text-align: center;
                            color: #4F8BF9;
                            margin-bottom: 20px;
                        }
                        .metadata {
                            text-align: center;
                            color: #666;
                            margin-bottom: 30px;
                        }
                        .content {
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        hr {
                            margin: 30px 0;
                            border: 0;
                            border-top: 1px solid #ddd;
                        }
                        h2 {
                            color: #4F8BF9;
                            margin-top: 30px;
                        }
                    </style>
                </head>
                <body>
                    <h1>${currentTextData.topic}</h1>
                    <div class="metadata">
                        <p>Language: ${currentTextData.language} | Level: ${currentTextData.level}</p>
                    </div>
                    <div class="content">
                        <div class="text">
                            ${currentTextData.text.replace(/\n/g, '<br>')}
                        </div>
                        
                        ${currentTextData.summary ? `
                            <hr>
                            <h2>Summary</h2>
                            <div class="summary">
                                ${currentTextData.summary.replace(/\n/g, '<br>')}
                            </div>
                        ` : ''}
                    </div>
                </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
    }
    
    // Save text
    function saveText() {
        // This will be handled by the server-side history feature
        showAlert('Text saved to history!', 'success');
    }
    
    // Clear text
    function clearText() {
        currentTextData = null;
        $('#textContent').addClass('d-none');
        $('#initialMessage').removeClass('d-none');
        $('#textTitle').html('<i class="fas fa-file-alt me-2"></i>Generated Text');
        $('#copyTextBtn, #printTextBtn, #saveTextBtn, #clearTextBtn').prop('disabled', true);
    }
    
    // Show alert message
    function showAlert(message, type = 'info') {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        // Add alert to the page
        $('main').prepend(alertHtml);
        
        // Auto-dismiss after 5 seconds
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
    }
</script>
{% endblock %}